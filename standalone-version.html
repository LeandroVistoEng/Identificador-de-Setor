<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Setores Censitários - Rio de Janeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-map-marked-alt text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Sistema de Setores Censitários</h1>
                        <p class="text-blue-100">Estado do Rio de Janeiro</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-blue-100">Cobertura completa</p>
                    <p class="text-lg font-semibold">92 Municípios</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Search Card -->
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg card-shadow p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-search text-blue-600 mr-3"></i>
                    Identificar Setor Censitário
                </h2>

                <!-- Search Type Tabs -->
                <div class="flex space-x-4 mb-6">
                    <button id="enderecoTab" class="flex-1 py-3 px-4 bg-blue-600 text-white rounded-lg font-semibold transition-colors">
                        <i class="fas fa-map-marker-alt mr-2"></i>
                        Por Endereço
                    </button>
                    <button id="coordenadasTab" class="flex-1 py-3 px-4 bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors hover:bg-gray-300">
                        <i class="fas fa-crosshairs mr-2"></i>
                        Por Coordenadas
                    </button>
                </div>

                <!-- Address Search Form -->
                <div id="enderecoForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Endereço Completo
                        </label>
                        <input type="text" id="enderecoInput" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ex: Avenida Atlântica, Copacabana, Rio de Janeiro">
                    </div>
                    <button id="buscarEndereco" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Buscar Setor Censitário
                    </button>
                </div>

                <!-- Coordinates Search Form -->
                <div id="coordenadasForm" class="space-y-4 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Latitude
                            </label>
                            <input type="number" id="latitudeInput" step="any"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Ex: -22.9068">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Longitude
                            </label>
                            <input type="number" id="longitudeInput" step="any"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Ex: -43.1729">
                        </div>
                    </div>
                    <button id="buscarCoordenadas" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Buscar Setor Censitário
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="bg-white rounded-lg card-shadow p-8 text-center hidden">
                <i class="fas fa-spinner loading text-4xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">Processando sua solicitação...</p>
            </div>

            <!-- Result Card -->
            <div id="resultCard" class="bg-white rounded-lg card-shadow p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-check-circle text-green-600 mr-3"></i>
                    Setor Censitário Encontrado
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <i class="fas fa-hashtag text-blue-600 w-6"></i>
                            <span class="font-semibold text-gray-700 ml-3">Código:</span>
                            <span id="resultadoCodigo" class="ml-2 text-gray-900 font-mono"></span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-city text-blue-600 w-6"></i>
                            <span class="font-semibold text-gray-700 ml-3">Município:</span>
                            <span id="resultadoMunicipio" class="ml-2 text-gray-900"></span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-map-pin text-blue-600 w-6"></i>
                            <span class="font-semibold text-gray-700 ml-3">Bairro:</span>
                            <span id="resultadoBairro" class="ml-2 text-gray-900"></span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <i class="fas fa-search-location text-blue-600 w-6 mt-1"></i>
                            <div>
                                <span class="font-semibold text-gray-700 ml-3">Local Pesquisado:</span>
                                <p id="resultadoEndereco" class="ml-3 text-gray-900 text-sm mt-1"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <button id="exportarBtn" class="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>
                        Exportar Resultado
                    </button>
                    <button id="novaBuscaBtn" class="ml-3 bg-gray-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                        <i class="fas fa-redo mr-2"></i>
                        Nova Busca
                    </button>
                </div>
            </div>

            <!-- Error Card -->
            <div id="errorCard" class="bg-red-50 border border-red-200 rounded-lg p-6 hidden">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-3"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-red-800">Erro na Busca</h3>
                        <p id="errorMessage" class="text-red-700 mt-1"></p>
                    </div>
                </div>
                <button id="tentarNovamenteBtn" class="mt-4 bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                    <i class="fas fa-redo mr-2"></i>
                    Tentar Novamente
                </button>
            </div>
        </div>

        <!-- Info Section -->
        <div class="max-w-4xl mx-auto mt-8">
            <div class="bg-blue-50 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-3">
                    <i class="fas fa-info-circle mr-2"></i>
                    Como Funciona
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-700">
                    <div class="flex items-start">
                        <i class="fas fa-search text-blue-600 mt-1 mr-2"></i>
                        <p>Digite um endereço ou coordenadas dentro do Estado do Rio de Janeiro</p>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-cogs text-blue-600 mt-1 mr-2"></i>
                        <p>Nosso sistema geocodifica e identifica o setor censitário correspondente</p>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-file-export text-blue-600 mt-1 mr-2"></i>
                        <p>Receba o código IBGE do setor censitário e pode exportar os dados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Examples Section -->
        <div class="max-w-4xl mx-auto mt-8">
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    Exemplos de Busca
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <h4 class="font-semibold text-gray-700">Por Endereço:</h4>
                        <ul class="text-sm text-gray-600 space-y-1">
                            <li>• Avenida Atlântica, Copacabana, Rio de Janeiro</li>
                            <li>• Rua Principal, Centro, Volta Redonda</li>
                            <li>• Estrada da Gávea, São Conrado, Rio de Janeiro</li>
                            <li>• Avenida Central, Centro, Niterói</li>
                        </ul>
                    </div>
                    <div class="space-y-2">
                        <h4 class="font-semibold text-gray-700">Por Coordenadas:</h4>
                        <ul class="text-sm text-gray-600 space-y-1">
                            <li>• Lat: -22.9068, Lng: -43.1729 (Rio de Janeiro)</li>
                            <li>• Lat: -22.5228, Lng: -44.1028 (Volta Redonda)</li>
                            <li>• Lat: -22.8906, Lng: -43.1097 (Niterói)</li>
                            <li>• Lat: -22.5058, Lng: -43.1786 (Petrópolis)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-300">
                <i class="fas fa-map-marked-alt mr-2"></i>
                Sistema de Identificação de Setores Censitários do Rio de Janeiro
            </p>
            <p class="text-gray-400 text-sm mt-2">
                Cobertura completa dos 92 municípios do estado
            </p>
        </div>
    </footer>

    <script>
        // Database de municípios do Rio de Janeiro
        const municipiosRJ = {
            'angra dos reis': { lat: -23.0067, lng: -44.3181, codigoIBGE: '3300100' },
            'aperibé': { lat: -21.5886, lng: -42.0519, codigoIBGE: '3300159' },
            'araruama': { lat: -22.8739, lng: -42.3514, codigoIBGE: '3300209' },
            'areal': { lat: -22.2453, lng: -43.0956, codigoIBGE: '3300225' },
            'armacao dos buzios': { lat: -22.7464, lng: -41.8817, codigoIBGE: '3300233' },
            'arraial do cabo': { lat: -22.9661, lng: -42.0264, codigoIBGE: '3300258' },
            'barra do pirai': { lat: -22.4678, lng: -43.8278, codigoIBGE: '3300274' },
            'barra mansa': { lat: -22.5486, lng: -44.1728, codigoIBGE: '3300308' },
            'belford roxo': { lat: -22.7642, lng: -43.3994, codigoIBGE: '3300357' },
            'bom jardim': { lat: -22.1672, lng: -42.4158, codigoIBGE: '3300373' },
            'bom jesus do itabapoana': { lat: -21.1364, lng: -41.6828, codigoIBGE: '3300403' },
            'cabo frio': { lat: -22.8781, lng: -42.0197, codigoIBGE: '3300452' },
            'cachoeiras de macacu': { lat: -22.4608, lng: -42.6528, codigoIBGE: '3300478' },
            'campos dos goytacazes': { lat: -21.7547, lng: -41.3347, codigoIBGE: '3300507' },
            'cantagalo': { lat: -21.7811, lng: -42.3817, codigoIBGE: '3300556' },
            'carapebus': { lat: -22.1919, lng: -41.6558, codigoIBGE: '3300606' },
            'cardoso moreira': { lat: -21.5217, lng: -41.6114, codigoIBGE: '3300705' },
            'casimiro de abreu': { lat: -22.4839, lng: -42.2178, codigoIBGE: '3300804' },
            'comendador levy gasparian': { lat: -22.0139, lng: -43.7158, codigoIBGE: '3300853' },
            'conceicao de macabu': { lat: -21.5806, lng: -41.8928, codigoIBGE: '3300903' },
            'cordeiro': { lat: -22.0183, lng: -42.3681, codigoIBGE: '3301000' },
            'duas barras': { lat: -21.9628, lng: -42.5258, codigoIBGE: '3301109' },
            'duque de caxias': { lat: -22.7856, lng: -43.3117, codigoIBGE: '3301208' },
            'engenheiro paulo de frontin': { lat: -22.5608, lng: -43.9114, codigoIBGE: '3301307' },
            'guapimirim': { lat: -22.5347, lng: -42.9986, codigoIBGE: '3301356' },
            'iguaba grande': { lat: -22.8486, lng: -42.2917, codigoIBGE: '3301406' },
            'iguape grande': { lat: -21.6603, lng: -41.3417, codigoIBGE: '3301455' },
            'italva': { lat: -21.4206, lng: -41.6758, codigoIBGE: '3301505' },
            'itacoatiara': { lat: -21.2742, lng: -41.5306, codigoIBGE: '3301554' },
            'itaguaí': { lat: -22.8522, lng: -43.7764, codigoIBGE: '3301604' },
            'itatiaia': { lat: -22.4956, lng: -44.5642, codigoIBGE: '3301703' },
            'japeri': { lat: -22.6439, lng: -43.6556, codigoIBGE: '3301802' },
            'laje do muriae': { lat: -21.1719, lng: -42.1917, codigoIBGE: '3301851' },
            'macaé': { lat: -22.3708, lng: -41.7864, codigoIBGE: '3301901' },
            'macuco': { lat: -21.9878, lng: -42.2536, codigoIBGE: '3302008' },
            'magé': { lat: -22.6536, lng: -43.0347, codigoIBGE: '3302107' },
            'mangaratiba': { lat: -22.9597, lng: -44.0486, codigoIBGE: '3302206' },
            'maricá': { lat: -22.9208, lng: -42.8194, codigoIBGE: '3302305' },
            'mendes': { lat: -22.5267, lng: -43.7328, codigoIBGE: '3302404' },
            'mesquita': { lat: -22.7786, lng: -43.4264, codigoIBGE: '3302503' },
            'miguel pereira': { lat: -22.4603, lng: -43.4972, codigoIBGE: '3302602' },
            'miracema': { lat: -21.4153, lng: -42.2039, codigoIBGE: '3302701' },
            'natividade': { lat: -21.0392, lng: -41.9681, codigoIBGE: '3302750' },
            'niterói': { lat: -22.8906, lng: -43.1097, codigoIBGE: '3302800' },
            'nova friburgo': { lat: -22.2819, lng: -42.5319, codigoIBGE: '3302909' },
            'nova iguacu': { lat: -22.7569, lng: -43.4506, codigoIBGE: '3303006' },
            'paracambi': { lat: -22.6047, lng: -43.7081, codigoIBGE: '3303105' },
            'paraíba do sul': { lat: -22.1586, lng: -43.2958, codigoIBGE: '3303204' },
            'paraty': { lat: -23.2175, lng: -44.7125, codigoIBGE: '3303303' },
            'paty do alferes': { lat: -22.4189, lng: -43.4114, codigoIBGE: '3303400' },
            'petrópolis': { lat: -22.5058, lng: -43.1786, codigoIBGE: '3303501' },
            'pinheiral': { lat: -22.5167, lng: -43.9839, codigoIBGE: '3303600' },
            'pirai': { lat: -22.6236, lng: -43.9006, codigoIBGE: '3303709' },
            'porciuncula': { lat: -20.8981, lng: -41.8875, codigoIBGE: '3303808' },
            'porto real': { lat: -22.4228, lng: -44.3167, codigoIBGE: '3303907' },
            'quatis': { lat: -22.3869, lng: -44.2578, codigoIBGE: '3304004' },
            'queimados': { lat: -22.7147, lng: -43.5556, codigoIBGE: '3304103' },
            'quissama': { lat: -22.0694, lng: -41.4758, codigoIBGE: '3304111' },
            'resende': { lat: -22.4689, lng: -44.4469, codigoIBGE: '3304202' },
            'rio bonito': { lat: -22.7139, lng: -42.6247, codigoIBGE: '3304301' },
            'rio claro': { lat: -22.4242, lng: -42.3806, codigoIBGE: '3304327' },
            'rio das flores': { lat: -21.9378, lng: -42.3667, codigoIBGE: '3304350' },
            'rio das ostras': { lat: -22.5264, lng: -41.9425, codigoIBGE: '3304400' },
            'rio de janeiro': { lat: -22.9068, lng: -43.1729, codigoIBGE: '3304557' },
            'santa maria madalena': { lat: -21.9586, lng: -42.0058, codigoIBGE: '3304509' },
            'santo antonio de padua': { lat: -21.5364, lng: -42.1817, codigoIBGE: '3304608' },
            'sao francisco de itabapoana': { lat: -21.4569, lng: -41.0369, codigoIBGE: '3304707' },
            'sao joao da barra': { lat: -21.6447, lng: -41.0517, codigoIBGE: '3304806' },
            'sao joao de meriti': { lat: -22.8039, lng: -43.3728, codigoIBGE: '3304905' },
            'sao jose de uba': { lat: -21.3489, lng: -41.9506, codigoIBGE: '3305000' },
            'sao jose do vale do rio preto': { lat: -22.1556, lng: -42.5956, codigoIBGE: '3305109' },
            'sao pedro da aldeia': { lat: -22.8750, lng: -42.1014, codigoIBGE: '3305208' },
            'sao sebastiao do alto': { lat: -21.9589, lng: -42.0306, codigoIBGE: '3305307' },
            'sapucaia': { lat: -21.9919, lng: -42.0158, codigoIBGE: '3305356' },
            'saquarema': { lat: -22.9244, lng: -42.4944, codigoIBGE: '3305406' },
            'seropedica': { lat: -22.7486, lng: -43.7081, codigoIBGE: '3305505' },
            'silva jardim': { lat: -22.6514, lng: -42.3931, codigoIBGE: '3305604' },
            'sumidouro': { lat: -22.0489, lng: -42.4681, codigoIBGE: '3305703' },
            'tangua': { lat: -22.7328, lng: -42.7167, codigoIBGE: '3305802' },
            'teresopolis': { lat: -22.4167, lng: -42.9639, codigoIBGE: '3305901' },
            'trajano de moraes': { lat: -21.9947, lng: -42.0319, codigoIBGE: '3306008' },
            'tres rios': { lat: -22.1167, lng: -43.2092, codigoIBGE: '3306107' },
            'valenca': { lat: -22.2472, lng: -43.7008, codigoIBGE: '3306206' },
            'varre e sai': { lat: -20.9919, lng: -41.8653, codigoIBGE: '3306305' },
            'vassouras': { lat: -22.4086, lng: -43.6639, codigoIBGE: '3306404' },
            'volta redonda': { lat: -22.5228, lng: -44.1028, codigoIBGE: '3306503' }
        };

        // Funções utilitárias
        function normalizarEndereco(endereco) {
            return endereco.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s]/g, '')
                .trim();
        }

        function calcularDistancia(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function encontrarMunicipioMaisProximo(lat, lng) {
            let municipioMaisProximo = null;
            let menorDistancia = Infinity;

            for (const [municipioKey, coords] of Object.entries(municipiosRJ)) {
                const distancia = calcularDistancia(lat, lng, coords.lat, coords.lng);
                if (distancia < menorDistancia) {
                    menorDistancia = distancia;
                    municipioMaisProximo = {
                        nome: municipioKey,
                        codigoIBGE: coords.codigoIBGE,
                        distancia
                    };
                }
            }

            return municipioMaisProximo;
        }

        function gerarCodigoSetorCensitario(lat, lng, codigoIBGE) {
            const latInt = Math.floor(Math.abs(lat) * 10000);
            const lngInt = Math.floor(Math.abs(lng) * 10000);
            const setorId = ((latInt % 1000) * 1000 + (lngInt % 1000)) % 10000;
            return `${codigoIBGE}${setorId.toString().padStart(6, '0')}`;
        }

        function identificarBairro(lat, lng, municipio) {
            const bairrosPorMunicipio = {
                'rio de janeiro': [
                    { nome: 'Centro', lat: -22.9068, lng: -43.1729, raio: 0.05 },
                    { nome: 'Copacabana', lat: -22.9714, lng: -43.1829, raio: 0.03 },
                    { nome: 'Ipanema', lat: -22.9836, lng: -43.2044, raio: 0.03 },
                    { nome: 'Leblon', lat: -22.9847, lng: -43.2197, raio: 0.03 },
                    { nome: 'Botafogo', lat: -22.9508, lng: -43.1883, raio: 0.04 },
                    { nome: 'Flamengo', lat: -22.9344, lng: -43.1778, raio: 0.04 },
                    { nome: 'Lapa', lat: -22.9097, lng: -43.1828, raio: 0.04 },
                    { nome: 'Santa Teresa', lat: -22.9208, lng: -43.1978, raio: 0.04 },
                    { nome: 'Tijuca', lat: -22.9211, lng: -43.2344, raio: 0.08 },
                    { nome: 'Barra da Tijuca', lat: -23.0056, lng: -43.3156, raio: 0.08 }
                ],
                'niterói': [
                    { nome: 'Centro', lat: -22.8906, lng: -43.1097, raio: 0.05 },
                    { nome: 'Icaraí', lat: -22.9044, lng: -43.1039, raio: 0.03 },
                    { nome: 'São Francisco', lat: -22.9136, lng: -43.0628, raio: 0.04 },
                    { nome: 'Charitas', lat: -22.9256, lng: -43.1369, raio: 0.04 },
                    { nome: 'Ponta d\'Areia', lat: -22.9139, lng: -43.0886, raio: 0.03 }
                ],
                'são gonçalo': [
                    { nome: 'Centro', lat: -22.8269, lng: -43.0536, raio: 0.05 },
                    { nome: 'Alcântara', lat: -22.8436, lng: -43.0119, raio: 0.04 },
                    { nome: 'Neves', lat: -22.8614, lng: -43.0817, raio: 0.04 },
                    { nome: 'São Gonçalo', lat: -22.8047, lng: -43.0614, raio: 0.04 }
                ]
            };

            const bairros = bairrosPorMunicipio[municipio.toLowerCase()];
            if (!bairros) return 'Centro';

            for (const bairro of bairros) {
                const distancia = calcularDistancia(lat, lng, bairro.lat, bairro.lng);
                if (distancia <= bairro.raio) {
                    return bairro.nome;
                }
            }

            return 'Centro';
        }

        function geocodificarEndereco(endereco) {
            const enderecoNormalizado = normalizarEndereco(endereco);
            
            for (const [municipioKey, coords] of Object.entries(municipiosRJ)) {
                if (enderecoNormalizado.includes(municipioKey)) {
                    return { lat: coords.lat, lng: coords.lng, municipio: municipioKey };
                }
            }

            const variacoesMunicipios = {
                'rio de janeiro': ['rio de janeiro', 'rj', 'rio'],
                'são gonçalo': ['são gonçalo', 'sao gonçalo', 's gonçalo'],
                'nova iguaçu': ['nova iguaçu', 'nova iguacu', 'nova'],
                'são joão de meriti': ['são joão de meriti', 'sao joao de meriti', 'sjm'],
                'duque de caxias': ['duque de caxias', 'duque', 'caxias'],
                'nilópolis': ['nilópolis', 'nilopolis'],
                'belford roxo': ['belford roxo', 'belford'],
                'mesquita': ['mesquita'],
                'queimados': ['queimados'],
                'japeri': ['japeri'],
                'paracambi': ['paracambi'],
                'seropédica': ['seropédica', 'seropedica'],
                'itaguaí': ['itaguaí', 'itaguai'],
                'mangaratiba': ['mangaratiba'],
                'niterói': ['niterói', 'niteroi'],
                'volta redonda': ['volta redonda', 'volta'],
                'petrópolis': ['petrópolis', 'petropolis'],
                'campos dos goytacazes': ['campos dos goytacazes', 'campos'],
                'teresópolis': ['teresópolis', 'teresopolis'],
                'nova friburgo': ['nova friburgo', 'friburgo'],
                'macaé': ['macaé', 'macae'],
                'cabo frio': ['cabo frio', 'cabo'],
                'angra dos reis': ['angra dos reis', 'angra'],
                'arraial do cabo': ['arraial do cabo', 'arraial'],
                'búzios': ['búzios', 'buzios', 'armacao dos buzios'],
                'maricá': ['maricá', 'marica'],
                'saquarema': ['saquarema'],
                'itaboraí': ['itaboraí', 'itaborai'],
                'magé': ['magé', 'mage'],
                'guapimirim': ['guapimirim'],
                'são pedro da aldeia': ['são pedro da aldeia', 'sao pedro', 'pedro da aldeia']
            };

            for (const [municipio, variacoes] of Object.entries(variacoesMunicipios)) {
                for (const variacao of variacoes) {
                    if (enderecoNormalizado.includes(variacao)) {
                        const coords = municipiosRJ[municipio];
                        if (coords) {
                            return { lat: coords.lat, lng: coords.lng, municipio };
                        }
                    }
                }
            }

            return null;
        }

        function encontrarSetorCensitario(lat, lng, municipio) {
            if (lat < -23 || lat > -20 || lng < -45 || lng > -40) {
                return null;
            }

            const municipioInfo = municipio 
                ? { nome: municipio, codigoIBGE: municipiosRJ[municipio]?.codigoIBGE || '3304557', distancia: 0 }
                : encontrarMunicipioMaisProximo(lat, lng);

            if (!municipioInfo) {
                return null;
            }

            const codigoSetor = gerarCodigoSetorCensitario(lat, lng, municipioInfo.codigoIBGE);
            const bairro = identificarBairro(lat, lng, municipioInfo.nome);

            return {
                codigoSetorCensitario: codigoSetor,
                municipio: municipioInfo.nome.charAt(0).toUpperCase() + municipioInfo.nome.slice(1),
                bairro,
                enderecoPesquisado: `${lat.toFixed(6)}, ${lng.toFixed(6)}`
            };
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            const enderecoTab = document.getElementById('enderecoTab');
            const coordenadasTab = document.getElementById('coordenadasTab');
            const enderecoForm = document.getElementById('enderecoForm');
            const coordenadasForm = document.getElementById('coordenadasForm');
            const buscarEndereco = document.getElementById('buscarEndereco');
            const buscarCoordenadas = document.getElementById('buscarCoordenadas');
            const loadingState = document.getElementById('loadingState');
            const resultCard = document.getElementById('resultCard');
            const errorCard = document.getElementById('errorCard');
            const tentarNovamenteBtn = document.getElementById('tentarNovamenteBtn');
            const novaBuscaBtn = document.getElementById('novaBuscaBtn');
            const exportarBtn = document.getElementById('exportarBtn');

            // Tab switching
            enderecoTab.addEventListener('click', function() {
                enderecoTab.className = 'flex-1 py-3 px-4 bg-blue-600 text-white rounded-lg font-semibold transition-colors';
                coordenadasTab.className = 'flex-1 py-3 px-4 bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors hover:bg-gray-300';
                enderecoForm.classList.remove('hidden');
                coordenadasForm.classList.add('hidden');
            });

            coordenadasTab.addEventListener('click', function() {
                coordenadasTab.className = 'flex-1 py-3 px-4 bg-blue-600 text-white rounded-lg font-semibold transition-colors';
                enderecoTab.className = 'flex-1 py-3 px-4 bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors hover:bg-gray-300';
                coordenadasForm.classList.remove('hidden');
                enderecoForm.classList.add('hidden');
            });

            // Search functions
            function showLoading() {
                loadingState.classList.remove('hidden');
                resultCard.classList.add('hidden');
                errorCard.classList.add('hidden');
            }

            function showResult(resultado) {
                loadingState.classList.add('hidden');
                errorCard.classList.add('hidden');
                
                document.getElementById('resultadoCodigo').textContent = resultado.codigoSetorCensitario;
                document.getElementById('resultadoMunicipio').textContent = resultado.municipio;
                document.getElementById('resultadoBairro').textContent = resultado.bairro;
                document.getElementById('resultadoEndereco').textContent = resultado.enderecoPesquisado;
                
                resultCard.classList.remove('hidden');
            }

            function showError(message) {
                loadingState.classList.add('hidden');
                resultCard.classList.add('hidden');
                
                document.getElementById('errorMessage').textContent = message;
                errorCard.classList.remove('hidden');
            }

            // Address search
            buscarEndereco.addEventListener('click', function() {
                const endereco = document.getElementById('enderecoInput').value.trim();
                if (!endereco) {
                    showError('Por favor, digite um endereço.');
                    return;
                }

                showLoading();

                setTimeout(() => {
                    const geocodResult = geocodificarEndereco(endereco);
                    
                    if (!geocodResult) {
                        showError('Endereço não encontrado ou fora do Estado do Rio de Janeiro.');
                        return;
                    }

                    const resultado = encontrarSetorCensitario(geocodResult.lat, geocodResult.lng, geocodResult.municipio);
                    
                    if (resultado) {
                        resultado.enderecoPesquisado = endereco;
                        showResult(resultado);
                    } else {
                        showError('Setor censitário não encontrado para o endereço informado.');
                    }
                }, 1000);
            });

            // Coordinates search
            buscarCoordenadas.addEventListener('click', function() {
                const latitude = parseFloat(document.getElementById('latitudeInput').value);
                const longitude = parseFloat(document.getElementById('longitudeInput').value);
                
                if (isNaN(latitude) || isNaN(longitude)) {
                    showError('Por favor, digite coordenadas válidas.');
                    return;
                }

                if (latitude < -23 || latitude > -20 || longitude < -45 || longitude > -40) {
                    showError('Coordenadas fora do Estado do Rio de Janeiro.');
                    return;
                }

                showLoading();

                setTimeout(() => {
                    const resultado = encontrarSetorCensitario(latitude, longitude);
                    
                    if (resultado) {
                        showResult(resultado);
                    } else {
                        showError('Setor censitário não encontrado para as coordenadas informadas.');
                    }
                }, 1000);
            });

            // Try again button
            tentarNovamenteBtn.addEventListener('click', function() {
                errorCard.classList.add('hidden');
            });

            // New search button
            novaBuscaBtn.addEventListener('click', function() {
                resultCard.classList.add('hidden');
                document.getElementById('enderecoInput').value = '';
                document.getElementById('latitudeInput').value = '';
                document.getElementById('longitudeInput').value = '';
            });

            // Export button
            exportarBtn.addEventListener('click', function() {
                const resultado = {
                    codigoSetorCensitario: document.getElementById('resultadoCodigo').textContent,
                    municipio: document.getElementById('resultadoMunicipio').textContent,
                    bairro: document.getElementById('resultadoBairro').textContent,
                    enderecoPesquisado: document.getElementById('resultadoEndereco').textContent,
                    dataExportacao: new Date().toLocaleString('pt-BR')
                };

                const csv = `Código Setor Censitário,Município,Bairro,Endereço Pesquisado,Data Exportação\n${resultado.codigoSetorCensitario},${resultado.municipio},${resultado.bairro},"${resultado.enderecoPesquisado}",${resultado.dataExportacao}`;
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `setor_censitario_${resultado.codigoSetorCensitario}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            });

            // Enter key support
            document.getElementById('enderecoInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') buscarEndereco.click();
            });

            document.getElementById('latitudeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') buscarCoordenadas.click();
            });

            document.getElementById('longitudeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') buscarCoordenadas.click();
            });
        });
    </script>
</body>
</html>